{% extends "base.html" %}

{% block title %}Prediction Results ‚Äî Custora AI{% endblock %}

{% block extra_css %}
<style>
  /* ============================================================
     RESULTS PAGE STYLES
  ============================================================ */

  .page-body > .container {
    padding-top: 0;
    max-width: 1200px;
  }

  .rs-section { padding: 48px 0 0; }
  .rs-section:last-child { padding-bottom: 80px; }

  .rs-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .rs-label::before {
    content: '';
    display: block;
    width: 16px; height: 2px;
    border-radius: 1px;
    background: var(--brand-gradient);
  }

  .rs-title {
    font-size: clamp(1.15rem, 2.5vw, 1.55rem);
    font-weight: 800;
    letter-spacing: -0.04em;
    color: var(--text-primary);
    margin-bottom: 4px;
    line-height: 1.2;
  }

  .rs-subtitle {
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .rs-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 28px;
    box-shadow: var(--shadow-card);
    transition: border-color var(--transition), box-shadow var(--transition);
    position: relative;
    overflow: hidden;
  }

  .rs-card:hover { border-color: var(--border-accent); }

  /* ============================================================
     PAGE HEADER
  ============================================================ */
  .results-header {
    padding: 56px 0 0;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
  }

  .results-header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    padding-top: 6px;
  }

  .btn-dl {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 9px 18px;
    border-radius: var(--radius-pill);
    font-family: var(--font-family);
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, border-color 0.18s ease;
    white-space: nowrap;
    border: none;
  }

  .btn-dl:hover  { transform: translateY(-1px); }
  .btn-dl:active { transform: translateY(0); }

  .btn-dl-primary {
    background: var(--brand-gradient);
    color: #fff;
    box-shadow: var(--shadow-btn);
  }
  .btn-dl-primary:hover { box-shadow: 0 8px 28px rgba(247,37,133,0.4); color: #fff; }

  .btn-dl-ghost {
    background: transparent;
    color: var(--text-primary);
    border: 1px solid var(--border);
  }
  .btn-dl-ghost:hover {
    border-color: var(--border-accent);
    background: var(--bg-surface);
    color: var(--text-primary);
  }

  /* ============================================================
     1. EXECUTIVE SUMMARY CARDS
  ============================================================ */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-top: 28px;
  }

  .summary-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 24px 20px;
    position: relative;
    overflow: hidden;
    transition: border-color var(--transition), box-shadow var(--transition), transform 0.2s ease;
    cursor: default;
  }

  .summary-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--brand-gradient);
    opacity: 0;
    transition: opacity var(--transition);
  }

  .summary-card:hover {
    border-color: var(--border-accent);
    box-shadow: var(--shadow-glow), var(--shadow-card);
    transform: translateY(-2px);
  }

  .summary-card:hover::before { opacity: 1; }

  .summary-card-icon {
    width: 36px; height: 36px;
    border-radius: var(--radius-sm);
    background: linear-gradient(135deg, rgba(247,37,133,0.12), rgba(67,97,238,0.12));
    border: 1px solid var(--border-accent);
    display: grid;
    place-items: center;
    font-size: 1rem;
    margin-bottom: 14px;
  }

  .summary-card-value {
    font-size: 1.9rem;
    font-weight: 800;
    letter-spacing: -0.05em;
    line-height: 1;
    margin-bottom: 4px;
    display: block;
  }

  .sv-gradient { background: var(--brand-gradient-text); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .sv-danger   { color: #f72585; }
  .sv-warning  { color: #ca8a04; }
  .sv-success  { color: #22c55e; }
  [data-theme="dark"] .sv-warning { color: #facc15; }

  .summary-card-label {
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.07em;
  }

  .summary-card-sub {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 6px;
    line-height: 1.4;
  }

  /* ============================================================
     2. MODEL PERFORMANCE
  ============================================================ */
  .metrics-layout {
    display: grid;
    grid-template-columns: 1fr 1.35fr;
    gap: 20px;
    margin-top: 28px;
  }

  .metrics-score-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }

  .metric-box {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 18px 14px;
    text-align: center;
    transition: border-color var(--transition), transform 0.18s ease;
  }

  .metric-box:hover { border-color: var(--border-accent); transform: translateY(-2px); }

  .metric-box-value {
    font-size: 1.6rem;
    font-weight: 800;
    letter-spacing: -0.04em;
    line-height: 1;
    background: var(--brand-gradient-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: block;
    margin-bottom: 4px;
  }

  .metric-box-label {
    font-size: 0.68rem;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .metrics-note {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: rgba(67,97,238,0.07);
    border: 1px solid rgba(67,97,238,0.18);
    border-radius: var(--radius-md);
    font-size: 0.76rem;
    color: var(--text-secondary);
  }

  .metrics-note-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #4361ee;
    flex-shrink: 0;
  }

  .conf-card-title {
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 14px;
  }

  .conf-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.84rem;
    margin-bottom: 14px;
  }

  .conf-table td {
    padding: 13px 18px;
    text-align: center;
    border: 1px solid var(--border);
    font-weight: 700;
    color: var(--text-primary);
  }

  .conf-table tr:nth-child(1) td:nth-child(1) { background: rgba(34,197,94,0.10);  color: #22c55e; }
  .conf-table tr:nth-child(2) td:nth-child(2) { background: rgba(34,197,94,0.10);  color: #22c55e; }
  .conf-table tr:nth-child(1) td:nth-child(2) { background: rgba(247,37,133,0.08); color: #f72585; }
  .conf-table tr:nth-child(2) td:nth-child(1) { background: rgba(247,37,133,0.08); color: #f72585; }

  /* ============================================================
     3. RISK DISTRIBUTION
  ============================================================ */
  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 28px;
  }

  .chart-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .chart-card-title {
    font-size: 0.88rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--text-primary);
  }

  .chart-live-badge {
    font-size: 0.63rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    padding: 3px 9px;
    border-radius: var(--radius-pill);
    background: rgba(34,197,94,0.1);
    border: 1px solid rgba(34,197,94,0.2);
    color: #22c55e;
  }

  .risk-pill-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 14px;
  }

  .risk-pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 11px;
    border-radius: var(--radius-pill);
    font-size: 0.72rem;
    font-weight: 700;
  }

  .risk-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }

  .rp-high { background: rgba(247,37,133,0.1); border: 1px solid rgba(247,37,133,0.22); color: #f72585; }
  .rp-med  { background: rgba(234,179,8,0.1);  border: 1px solid rgba(234,179,8,0.25);  color: #ca8a04; }
  .rp-low  { background: rgba(34,197,94,0.1);  border: 1px solid rgba(34,197,94,0.22);  color: #22c55e; }
  [data-theme="dark"] .rp-med { color: #facc15; }

  /* ============================================================
     4. BUSINESS IMPACT
  ============================================================ */
  .impact-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 14px;
    margin-bottom: 24px;
  }

  .impact-box {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 20px 18px;
    transition: border-color var(--transition), transform 0.18s ease;
  }

  .impact-box:hover { border-color: var(--border-accent); transform: translateY(-2px); }

  .impact-box-label {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.09em;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .impact-box-value {
    font-size: 1.65rem;
    font-weight: 800;
    letter-spacing: -0.04em;
    line-height: 1;
    background: var(--brand-gradient-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: block;
  }

  .impact-box-value.iv-danger {
    background: none;
    -webkit-text-fill-color: #f72585;
    color: #f72585;
  }

  .impact-box-note {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 4px;
  }

  /* Premium Slider */
  .slider-card {
    background: linear-gradient(135deg,
      rgba(247,37,133,0.05) 0%,
      rgba(155,45,202,0.05) 50%,
      rgba(67,97,238,0.05) 100%);
    border: 1px solid var(--border-accent);
    border-radius: var(--radius-lg);
    padding: 26px 28px;
    position: relative;
    overflow: hidden;
  }

  .slider-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--brand-gradient);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  }

  .slider-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }

  .slider-title     { font-size: 0.9rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.01em; }
  .slider-title-sub { font-size: 0.73rem; color: var(--text-muted); margin-top: 2px; }

  .slider-rate-badge {
    display: inline-flex;
    align-items: baseline;
    gap: 2px;
    padding: 4px 14px;
    background: var(--bg-surface);
    border: 1px solid var(--border-accent);
    border-radius: var(--radius-pill);
  }

  .slider-rate-num {
    font-size: 1.2rem;
    font-weight: 800;
    letter-spacing: -0.04em;
    background: var(--brand-gradient-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .slider-rate-pct { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); }

  .c-range {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 5px;
    border-radius: var(--radius-pill);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    outline: none;
    margin: 0 0 8px;
    cursor: pointer;
  }

  .c-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px; height: 20px;
    border-radius: 50%;
    background: var(--brand-gradient);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(247,37,133,0.4);
    border: 2px solid var(--bg-surface);
    transition: transform 0.18s ease, box-shadow 0.18s ease;
  }

  .c-range::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 4px 16px rgba(247,37,133,0.5);
  }

  .c-range::-moz-range-thumb {
    width: 18px; height: 18px;
    border-radius: 50%;
    background: var(--brand-gradient);
    cursor: pointer;
    border: 2px solid var(--bg-surface);
    box-shadow: 0 2px 8px rgba(247,37,133,0.4);
  }

  .slider-range-labels {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .slider-range-label { font-size: 0.64rem; color: var(--text-muted); font-weight: 500; }

  .slider-results {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  .slider-result-box {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 16px 18px;
    text-align: center;
  }

  .slider-result-label {
    font-size: 0.66rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .slider-result-value {
    font-size: 1.4rem;
    font-weight: 800;
    letter-spacing: -0.04em;
    background: var(--brand-gradient-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: block;
  }

  /* ============================================================
     5. AI STRATEGY
  ============================================================ */
  .ai-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-card);
    margin-top: 28px;
    transition: border-color var(--transition);
  }

  .ai-card:hover { border-color: var(--border-accent); }

  .ai-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 22px 26px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 14px;
    background: linear-gradient(135deg,
      rgba(247,37,133,0.04) 0%,
      rgba(155,45,202,0.04) 100%);
  }

  .ai-card-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .ai-card-icon {
    width: 42px; height: 42px;
    border-radius: var(--radius-md);
    background: var(--brand-gradient);
    display: grid;
    place-items: center;
    font-size: 1.2rem;
    box-shadow: 0 4px 14px rgba(247,37,133,0.3);
    flex-shrink: 0;
  }

  .ai-card-heading {
    font-size: 0.95rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text-primary);
    margin-bottom: 2px;
  }

  .ai-card-sub { font-size: 0.74rem; color: var(--text-muted); }

  /* id="generateAI" styled via ID selector so JS keeps working */
  #generateAI {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: var(--brand-gradient);
    color: #fff;
    border: none;
    border-radius: var(--radius-pill);
    font-family: var(--font-family);
    font-size: 0.83rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: var(--shadow-btn);
    transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
    white-space: nowrap;
  }

  #generateAI:hover  { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(247,37,133,0.45); }
  #generateAI:active { transform: translateY(0); }

  .ai-card-body {
    padding: 26px;
    min-height: 110px;
  }

  .ai-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 28px 0;
    text-align: center;
  }

  .ai-empty-icon {
    width: 48px; height: 48px;
    border-radius: var(--radius-lg);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    display: grid;
    place-items: center;
    font-size: 1.3rem;
  }

  .ai-empty-text {
    font-size: 0.82rem;
    color: var(--text-muted);
    max-width: 280px;
    line-height: 1.55;
  }

  /* id="aiContent" output ‚Äî JS injects innerHTML here */
  #aiContent {
    font-size: 0.88rem;
    color: var(--text-secondary);
    line-height: 1.75;
  }

  #aiContent h6 {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #aiContent h6::before {
    content: '';
    display: block;
    width: 12px; height: 2px;
    border-radius: 1px;
    background: var(--brand-gradient);
  }

  #aiContent p { white-space: pre-wrap; margin: 0; }

  /* ============================================================
     6. DATASET TABLE
  ============================================================ */
  .table-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 14px;
  }

  .table-meta-info {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.77rem;
    color: var(--text-muted);
    font-weight: 500;
  }

  .rs-table-wrap {
    overflow-x: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    max-height: 380px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--bg-elevated) transparent;
  }

  .rs-table-wrap::-webkit-scrollbar { width: 5px; height: 5px; }
  .rs-table-wrap::-webkit-scrollbar-track { background: transparent; }
  .rs-table-wrap::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 3px; }

  .rs-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.79rem;
    min-width: 700px;
  }

  .rs-table thead { position: sticky; top: 0; z-index: 2; }

  .rs-table thead th {
    background: var(--bg-elevated);
    color: var(--text-muted);
    font-size: 0.66rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 11px 16px;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
    text-align: left;
  }

  .rs-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background var(--transition);
  }

  .rs-table tbody tr:last-child { border-bottom: none; }
  .rs-table tbody tr:hover { background: var(--bg-elevated); }

  .rs-table tbody td {
    padding: 10px 16px;
    color: var(--text-secondary);
    white-space: nowrap;
    font-size: 0.78rem;
  }

  .rs-table tbody td strong { font-weight: 700; color: var(--text-primary); }

  .risk-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: var(--radius-pill);
    font-size: 0.64rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .rb-high { background: rgba(247,37,133,0.12); border: 1px solid rgba(247,37,133,0.25); color: #f72585; }
  .rb-med  { background: rgba(234,179,8,0.12);  border: 1px solid rgba(234,179,8,0.28);  color: #ca8a04; }
  .rb-low  { background: rgba(34,197,94,0.12);  border: 1px solid rgba(34,197,94,0.25);  color: #22c55e; }
  [data-theme="dark"] .rb-med { color: #facc15; }

  /* ============================================================
     RESPONSIVE
  ============================================================ */
  @media (max-width: 1024px) {
    .metrics-layout     { grid-template-columns: 1fr; }
    .metrics-score-grid { grid-template-columns: repeat(4, 1fr); }
  }

  @media (max-width: 768px) {
    .summary-grid       { grid-template-columns: repeat(2, 1fr); }
    .charts-grid        { grid-template-columns: 1fr; }
    .impact-grid        { grid-template-columns: 1fr; }
    .slider-results     { grid-template-columns: 1fr; }
    .metrics-score-grid { grid-template-columns: repeat(2, 1fr); }
    .results-header     { flex-direction: column; }
    .ai-card-header     { flex-direction: column; align-items: flex-start; }
  }

  @media (max-width: 520px) {
    .summary-grid { grid-template-columns: 1fr 1fr; }
    .summary-card-value { font-size: 1.5rem; }
  }
</style>
{% endblock %}


{% block content %}

<!-- Plotly ‚Äî single load at top -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


<!-- ============================================================
     PAGE HEADER
============================================================ -->
<div class="results-header fade-up">
  <div>
    <div class="rs-label">Prediction Results</div>
    <h1 class="rs-title">Churn Analysis Report</h1>
    <p class="rs-subtitle">
      ML ensemble pipeline complete ‚Äî <strong>{{ total }}</strong> records analysed.
    </p>
  </div>

  <div class="results-header-actions">
    <!-- href="/download/csv" preserved -->
    <a href="/download/csv" class="btn-dl btn-dl-ghost">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
        <path d="M7 1v8M4 8l3 3 3-3M1 12h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Download CSV
    </a>
    <!-- id="downloadPDF" preserved -->
    <button id="downloadPDF" class="btn-dl btn-dl-primary">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
        <path d="M2 2h7l3 3v8H2V2z" stroke="white" stroke-width="1.3" fill="none" stroke-linejoin="round"/>
        <path d="M9 2v3h3M4 7h6M4 9h4" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
      </svg>
      Download PDF
    </button>
  </div>
</div>


<!-- ============================================================
     1. EXECUTIVE SUMMARY
     Jinja: total, high, revenue_at_risk, annual_revenue_saved
============================================================ -->
<div class="rs-section">
  <div class="rs-label">Executive Summary</div>
  <div class="summary-grid">

    <div class="summary-card fade-up" style="transition-delay:.04s">
      <div class="summary-card-icon">üë•</div>
      <span class="summary-card-value sv-gradient">{{ total }}</span>
      <div class="summary-card-label">Total Customers</div>
      <div class="summary-card-sub">Records in this analysis</div>
    </div>

    <div class="summary-card fade-up" style="transition-delay:.08s">
      <div class="summary-card-icon">üî¥</div>
      <span class="summary-card-value sv-danger">{{ high }}</span>
      <div class="summary-card-label">High Risk</div>
      <div class="summary-card-sub">Immediate intervention required</div>
    </div>

    <div class="summary-card fade-up" style="transition-delay:.12s">
      <div class="summary-card-icon">‚ö†Ô∏è</div>
      <span class="summary-card-value sv-warning" style="font-size:1.4rem">‚Çπ {{ revenue_at_risk }}</span>
      <div class="summary-card-label">Revenue At Risk / Mo</div>
      <div class="summary-card-sub">From high-risk segment</div>
    </div>

    <div class="summary-card fade-up" style="transition-delay:.16s">
      <div class="summary-card-icon">‚úÖ</div>
      <span class="summary-card-value sv-success" style="font-size:1.4rem">‚Çπ {{ annual_revenue_saved }}</span>
      <div class="summary-card-label">Annual Revenue Protected</div>
      <div class="summary-card-sub">Projected with retention strategy</div>
    </div>

  </div>
</div>


<!-- ============================================================
     2. MODEL PERFORMANCE
     Jinja: metrics.accuracy, .precision, .recall, .f1, .conf_matrix
============================================================ -->
{% if metrics %}
<div class="rs-section fade-up">
  <div class="rs-label">Model Performance</div>
  <div class="rs-title" style="margin-bottom:20px">Validation metrics</div>

  <div class="metrics-layout">

    <div class="rs-card" style="padding:24px;display:flex;flex-direction:column">
      <div class="metrics-score-grid">
        <div class="metric-box">
          <span class="metric-box-value">{{ metrics.accuracy }}</span>
          <div class="metric-box-label">Accuracy</div>
        </div>
        <div class="metric-box">
          <span class="metric-box-value">{{ metrics.precision }}</span>
          <div class="metric-box-label">Precision</div>
        </div>
        <div class="metric-box">
          <span class="metric-box-value">{{ metrics.recall }}</span>
          <div class="metric-box-label">Recall</div>
        </div>
        <div class="metric-box">
          <span class="metric-box-value">{{ metrics.f1 }}</span>
          <div class="metric-box-label">F1 Score</div>
        </div>
      </div>
      <div class="metrics-note" style="margin-top:auto">
        <div class="metrics-note-dot"></div>
        Model optimized for high churn recall ‚Äî minimizing missed at-risk customers.
      </div>
    </div>

    <div class="rs-card" style="padding:24px">
      <div class="conf-card-title">Confusion Matrix</div>
      <table class="conf-table">
        {% for row in metrics.conf_matrix %}
        <tr>{% for val in row %}<td>{{ val }}</td>{% endfor %}</tr>
        {% endfor %}
      </table>
      <div style="display:flex;gap:16px;flex-wrap:wrap">
        <span style="font-size:0.71rem;color:#22c55e;font-weight:600">‚úì Correct predictions</span>
        <span style="font-size:0.71rem;color:#f72585;font-weight:600">‚úï Misclassifications</span>
      </div>
    </div>

  </div>
</div>
{% endif %}


<!-- ============================================================
     3. RISK DISTRIBUTION
     IDs: donutChart, barChart ‚Äî preserved
     Jinja: high, medium, low
============================================================ -->
<div class="rs-section fade-up">
  <div class="rs-label">Risk Distribution</div>
  <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:20px">
    <div class="rs-title">Customer risk breakdown</div>
    <div class="risk-pill-row" style="margin-top:0">
      <span class="risk-pill rp-high"><span class="risk-dot" style="background:#f72585"></span>High ‚Äî {{ high }}</span>
      <span class="risk-pill rp-med"><span class="risk-dot" style="background:#ca8a04"></span>Medium ‚Äî {{ medium }}</span>
      <span class="risk-pill rp-low"><span class="risk-dot" style="background:#22c55e"></span>Low ‚Äî {{ low }}</span>
    </div>
  </div>

  <div class="charts-grid">
    <div class="rs-card">
      <div class="chart-card-header">
        <span class="chart-card-title">Risk Distribution</span>
        <span class="chart-live-badge">Donut</span>
      </div>
      <div id="donutChart"></div>
    </div>
    <div class="rs-card">
      <div class="chart-card-header">
        <span class="chart-card-title">Risk Count Comparison</span>
        <span class="chart-live-badge">Bar</span>
      </div>
      <div id="barChart"></div>
    </div>
  </div>
</div>


<!-- ============================================================
     4. BUSINESS IMPACT
     Jinja: saved_customers, revenue_saved, annual_revenue_saved, revenue_at_risk
     IDs: retentionSlider, retentionValue, dynamicSaved, dynamicRevenue ‚Äî preserved
============================================================ -->
<div class="rs-section fade-up">
  <div class="rs-label">Business Impact</div>
  <div style="margin-bottom:22px">
    <div class="rs-title">Revenue impact estimation</div>
    <p class="rs-subtitle">Based on assumed 30% retention success rate for high-risk customers.</p>
  </div>

  <div class="impact-grid">
    <div class="impact-box">
      <div class="impact-box-label">Customers Saved</div>
      <span class="impact-box-value">{{ saved_customers }}</span>
      <div class="impact-box-note">At 30% retention rate</div>
    </div>
    <div class="impact-box">
      <div class="impact-box-label">Monthly Revenue Saved</div>
      <span class="impact-box-value">‚Çπ {{ revenue_saved }}</span>
      <div class="impact-box-note">Recurring monthly impact</div>
    </div>
    <div class="impact-box">
      <div class="impact-box-label">Annual Revenue Protected</div>
      <span class="impact-box-value">‚Çπ {{ annual_revenue_saved }}</span>
      <div class="impact-box-note">Projected annualised figure</div>
    </div>
    <div class="impact-box">
      <div class="impact-box-label">Revenue At Risk (Monthly)</div>
      <span class="impact-box-value iv-danger">‚Çπ {{ revenue_at_risk }}</span>
      <div class="impact-box-note">From high-risk segment</div>
    </div>
  </div>

  <!-- Premium Retention Slider -->
  <div class="slider-card">
    <div class="slider-header">
      <div>
        <div class="slider-title">Adjust Retention Success Rate</div>
        <div class="slider-title-sub">Drag to model different intervention scenarios</div>
      </div>
      <div class="slider-rate-badge">
        <!-- id="retentionValue" preserved -->
        <span class="slider-rate-num" id="retentionValue">30</span>
        <span class="slider-rate-pct">%</span>
      </div>
    </div>

    <!-- id="retentionSlider" preserved; min/max/value preserved -->
    <input type="range" min="10" max="60" value="30" id="retentionSlider" class="c-range"/>

    <div class="slider-range-labels">
      <span class="slider-range-label">10% Conservative</span>
      <span class="slider-range-label">60% Optimistic</span>
    </div>

    <div class="slider-results">
      <div class="slider-result-box">
        <div class="slider-result-label">Projected Customers Saved</div>
        <!-- id="dynamicSaved" preserved -->
        <span class="slider-result-value" id="dynamicSaved">{{ saved_customers }}</span>
      </div>
      <div class="slider-result-box">
        <div class="slider-result-label">Projected Monthly Revenue Saved</div>
        <!-- id="dynamicRevenue" preserved -->
        <span class="slider-result-value" id="dynamicRevenue">‚Çπ {{ revenue_saved }}</span>
      </div>
    </div>
  </div>
</div>


<!-- ============================================================
     5. AI STRATEGY
     id="generateAI", id="aiContent" ‚Äî preserved
============================================================ -->
<div class="rs-section fade-up">
  <div class="rs-label">AI Intelligence</div>

  <div class="ai-card">
    <div class="ai-card-header">
      <div class="ai-card-header-left">
        <div class="ai-card-icon">ü§ñ</div>
        <div>
          <div class="ai-card-heading">AI Risk Strategy</div>
          <div class="ai-card-sub">Powered by GROQ CLOUD ‚Äî generates actionable retention recommendations</div>
        </div>
      </div>
      <!-- id="generateAI" preserved -->
      <button id="generateAI">
        <svg width="13" height="13" viewBox="0 0 14 14" fill="none">
          <path d="M7 1l1.5 4.5H13l-3.75 2.75 1.5 4.5L7 10l-3.75 2.75 1.5-4.5L1 5.5h4.5L7 1z" fill="white"/>
        </svg>
        Generate AI Strategy
      </button>
    </div>

    <div class="ai-card-body">

      <!-- Default empty state -->
      <div class="ai-empty-state" id="aiEmptyState">
        <div class="ai-empty-icon">‚ú®</div>
        <p class="ai-empty-text">
          Click <strong>Generate AI Strategy</strong> to receive Claude-powered retention
          recommendations tailored to your churn data.
        </p>
      </div>

      <!-- id="aiContent" preserved ‚Äî JS innerHTML target -->
      <div id="aiContent" style="display:none">
        Click the button to generate AI-driven insights.
      </div>

    </div>
  </div>
</div>


<!-- ============================================================
     6. DATASET PREVIEW TABLE
     Jinja: columns, tables, total ‚Äî preserved
============================================================ -->
<div class="rs-section fade-up">
  <div class="rs-label">Dataset Preview</div>

  <div class="table-meta">
    <div class="rs-title" style="font-size:1.05rem">Customer prediction table</div>
    <div class="table-meta-info">
      <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="currentColor" stroke-width="1.3">
        <circle cx="6.5" cy="6.5" r="5.5"/>
        <path d="M6.5 6v3M6.5 4.5v.01" stroke-linecap="round"/>
      </svg>
      Showing first 10 rows of {{ total }} records
    </div>
  </div>

  <div class="rs-table-wrap">
    <table class="rs-table">
      <thead>
        <tr>
          {% for col in columns %}<th>{{ col }}</th>{% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in tables %}
        <tr>
          {% for col in columns %}
            {% if col == "Risk_Level" %}
              <td>
                {% if row[col] == "High Risk" %}
                  <span class="risk-badge rb-high">High Risk</span>
                {% elif row[col] == "Medium Risk" %}
                  <span class="risk-badge rb-med">Medium Risk</span>
                {% else %}
                  <span class="risk-badge rb-low">Low Risk</span>
                {% endif %}
              </td>
            {% elif col == "Churn_Probability (%)" %}
              <td><strong>{{ row[col] }}%</strong></td>
            {% else %}
              <td>{{ row[col] }}</td>
            {% endif %}
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
/* ============================================================
   PLOTLY ‚Äî donutChart, barChart IDs preserved
   high, medium, low Jinja vars preserved
============================================================ */
function getTheme() {
  return document.documentElement.getAttribute('data-theme') || 'dark';
}

function chartPalette() {
  const dark = getTheme() === 'dark';
  return {
    paper: 'rgba(0,0,0,0)',
    plot:  'rgba(0,0,0,0)',
    font:  dark ? '#9896b0' : '#4e4c65',
    grid:  dark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.06)',
  };
}

var riskValues = [{{ high|int }}, {{ medium|int }}, {{ low|int }}];
var riskLabels = ['High Risk', 'Medium Risk', 'Low Risk'];
var riskColors = ['#f72585', '#ca8a04', '#22c55e'];

function renderCharts() {
  const p = chartPalette();
  const base = {
    paper_bgcolor: p.paper,
    plot_bgcolor:  p.plot,
    font: { family: 'Plus Jakarta Sans, system-ui', color: p.font },
  };

  Plotly.newPlot('donutChart', [{
    values:    riskValues,
    labels:    riskLabels,
    type:      'pie',
    hole:      0.6,
    marker:    { colors: riskColors },
    textinfo:  'label+percent',
    hoverinfo: 'label+value+percent',
    textfont:  { size: 11 },
  }], {
    ...base,
    height: 300,
    showlegend: false,
    margin: { t: 16, b: 16, l: 16, r: 16 },
  }, { responsive: true, displayModeBar: false });

  Plotly.newPlot('barChart', [{
    x: riskLabels,
    y: riskValues,
    type: 'bar',
    marker: { color: riskColors, opacity: 0.88 },
    hovertemplate: '%{x}: <b>%{y}</b><extra></extra>',
  }], {
    ...base,
    height: 300,
    margin: { t: 16, b: 44, l: 44, r: 16 },
    yaxis: { gridcolor: p.grid, tickfont: { size: 10, color: p.font }, zeroline: false },
    xaxis: { tickfont: { size: 10, color: p.font } },
    bargap: 0.45,
  }, { responsive: true, displayModeBar: false });
}

renderCharts();

document.getElementById('themeToggle')?.addEventListener('click', () => {
  setTimeout(renderCharts, 320);
});


/* ============================================================
   RETENTION SLIDER
   IDs: retentionSlider, retentionValue, dynamicSaved, dynamicRevenue ‚Äî preserved
   Jinja: high, avg_monthly_revenue ‚Äî preserved
============================================================ */
const slider        = document.getElementById('retentionSlider');
const retentionDisp = document.getElementById('retentionValue');
const dynSaved      = document.getElementById('dynamicSaved');
const dynRevenue    = document.getElementById('dynamicRevenue');

const highRisk   = {{ high }};
const avgRevenue = {{ avg_monthly_revenue }};

function updateSliderFill() {
  const pct = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
  slider.style.background =
    `linear-gradient(to right,#f72585 0%,#4361ee ${pct}%,var(--bg-elevated) ${pct}%)`;
}

slider.addEventListener('input', function() {
  const rate = parseInt(slider.value);
  retentionDisp.innerText = rate;

  const saved   = Math.round(highRisk * (rate / 100));
  const revenue = (saved * avgRevenue).toFixed(2);

  document.getElementById('dynamicSaved').innerText   = saved;
  document.getElementById('dynamicRevenue').innerText = '‚Çπ ' + revenue;

  updateSliderFill();
});

updateSliderFill();


/* ============================================================
   AI BUTTON
   id="generateAI", id="aiContent", /generate_ai ‚Äî preserved
   total, high, medium, low Jinja vars ‚Äî preserved
============================================================ */
document.getElementById('generateAI').addEventListener('click', function() {
  const btn = this;
  btn.style.opacity       = '0.65';
  btn.style.pointerEvents = 'none';
  btn.innerHTML = `
    <svg width="13" height="13" viewBox="0 0 18 18" fill="none"
         style="animation:spin .75s linear infinite;flex-shrink:0">
      <circle cx="9" cy="9" r="7" stroke="rgba(255,255,255,.3)" stroke-width="2"/>
      <path d="M9 2a7 7 0 017 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
    </svg>
    Generating‚Ä¶`;

  fetch('/generate_ai', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      total:  {{ total }},
      high:   {{ high }},
      medium: {{ medium }},
      low:    {{ low }}
    })
  })
  .then(res => res.json())
  .then(data => {
    window.latestAISummary = data;

    document.getElementById('aiEmptyState').style.display = 'none';

    const aiContent = document.getElementById('aiContent');
    aiContent.style.display = 'block';
    aiContent.innerHTML = `
      <h6>Executive Summary</h6>
      <p>${data.summary || ''}</p>
    `;

    btn.style.opacity       = '1';
    btn.style.pointerEvents = '';
    btn.innerHTML = `
      <svg width="13" height="13" viewBox="0 0 14 14" fill="none">
        <path d="M7 1l1.5 4.5H13l-3.75 2.75 1.5 4.5L7 10l-3.75 2.75 1.5-4.5L1 5.5h4.5L7 1z" fill="white"/>
      </svg>
      Regenerate Strategy`;
  })
  .catch(() => {
    btn.style.opacity       = '1';
    btn.style.pointerEvents = '';
    btn.textContent = '‚ö† Retry';
  });
});


/* ============================================================
   PDF DOWNLOAD
   id="downloadPDF", /download/pdf, captureChartImage ‚Äî preserved
   total, high, medium, low Jinja vars ‚Äî preserved
============================================================ */
async function captureChartImage() {
  return await Plotly.toImage(
    document.getElementById('donutChart'),
    { format: 'png', width: 800, height: 500 }
  );
}

document.getElementById('downloadPDF').addEventListener('click', async function() {
  const btn = this;
  btn.textContent = 'Generating PDF‚Ä¶';
  btn.disabled    = true;

  const chartImage = await captureChartImage();

  fetch('/download/pdf', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      total:       {{ total }},
      high:        {{ high }},
      medium:      {{ medium }},
      low:         {{ low }},
      ai_summary:  window.latestAISummary || {},
      chart_image: chartImage
    })
  })
  .then(response => response.blob())
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a   = document.createElement('a');
    a.href     = url;
    a.download = 'custora_ai_report.pdf';
    a.click();
    window.URL.revokeObjectURL(url);
  })
  .finally(() => {
    btn.innerHTML = `
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
        <path d="M2 2h7l3 3v8H2V2z" stroke="white" stroke-width="1.3" fill="none" stroke-linejoin="round"/>
        <path d="M9 2v3h3M4 7h6M4 9h4" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
      </svg>
      Download PDF`;
    btn.disabled = false;
  });
});


/* Spin keyframe */
const _s = document.createElement('style');
_s.textContent = '@keyframes spin{to{transform:rotate(360deg)}}';
document.head.appendChild(_s);
</script>
{% endblock %}