{% extends "base.html" %}

{% block title %}Upload Dataset â€” Custora AI{% endblock %}

{% block extra_css %}
<style>
  /* ============================================================
     UPLOAD PAGE STYLES
  ============================================================ */

  .page-body > .container {
    padding-top: 0;
    max-width: 1100px;
  }

  /* â”€â”€ Section spacing â”€â”€ */
  .up-section {
    padding: 48px 0 0;
  }

  /* â”€â”€ Section label â”€â”€ */
  .up-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .up-label::before {
    content: '';
    display: block;
    width: 16px; height: 2px;
    border-radius: 1px;
    background: var(--brand-gradient);
  }

  /* ============================================================
     1. PAGE HEADER
  ============================================================ */
  .upload-header {
    padding: 56px 0 0;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 24px;
    flex-wrap: wrap;
  }

  .upload-header-text {}

  .upload-h1 {
    font-size: clamp(1.65rem, 3.5vw, 2.4rem);
    font-weight: 800;
    letter-spacing: -0.045em;
    line-height: 1.1;
    color: var(--text-primary);
    margin-bottom: 10px;
  }

  .upload-h1 span {
    background: var(--brand-gradient-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .upload-sub {
    font-size: 0.9rem;
    color: var(--text-secondary);
    max-width: 520px;
    line-height: 1.65;
  }

  /* Required format pills row */
  .upload-format-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 14px;
  }

  .format-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }

  .format-pill {
    display: inline-block;
    padding: 3px 10px;
    border-radius: var(--radius-pill);
    font-size: 0.67rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-family: 'Courier New', monospace;
    transition: border-color var(--transition);
  }

  .format-pill:hover { border-color: var(--border-accent); }

  /* ============================================================
     2. DRAG & DROP UPLOAD ZONE
  ============================================================ */
  .up-section-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    padding: 32px;
    box-shadow: var(--shadow-card);
    margin-top: 36px;
    transition: border-color var(--transition);
  }

  .upload-zone {
    position: relative;
    border: 2px dashed var(--border);
    border-radius: var(--radius-lg);
    padding: 56px 32px;
    text-align: center;
    cursor: pointer;
    transition: border-color var(--transition), background var(--transition), box-shadow var(--transition);
    background: var(--bg-elevated);
    overflow: hidden;
  }

  /* Subtle gradient pulse in background */
  .upload-zone::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 50% 40%,
      rgba(155,45,202,0) 0%,
      transparent 70%);
    transition: background 0.4s ease;
    pointer-events: none;
  }

  .upload-zone.drag-over,
  .upload-zone:hover {
    border-color: var(--brand-purple);
    background: var(--bg-surface);
    box-shadow: 0 0 0 4px rgba(155,45,202,0.08);
  }

  .upload-zone.drag-over::before,
  .upload-zone:hover::before {
    background: radial-gradient(ellipse at 50% 40%,
      rgba(155,45,202,0.07) 0%,
      transparent 70%);
  }

  .upload-zone.drag-over {
    border-color: var(--brand-pink);
    box-shadow: 0 0 0 4px rgba(247,37,133,0.1);
  }

  /* File input is hidden completely â€” triggered only via JS */
  #fileInput {
    display: none;
  }

  .upload-zone {
    cursor: default;
  }

  .upload-zone-icon {
    width: 64px; height: 64px;
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg,
      rgba(247,37,133,0.12), rgba(67,97,238,0.12));
    border: 1px solid var(--border-accent);
    display: grid;
    place-items: center;
    margin: 0 auto 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .upload-zone.has-file .upload-zone-icon,
  .upload-zone.drag-over .upload-zone-icon {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 12px 32px rgba(155,45,202,0.2);
  }

  .upload-zone-icon svg {
    width: 28px; height: 28px;
    color: var(--brand-purple);
    transition: color var(--transition);
  }

  .upload-zone.drag-over .upload-zone-icon svg { color: var(--brand-pink); }

  .upload-zone-title {
    font-size: 1.05rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--text-primary);
    margin-bottom: 6px;
  }

  .upload-zone-sub {
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-bottom: 24px;
    line-height: 1.5;
  }

  /* Browse button â€” triggers #fileInput via JS click */
  .btn-browse {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 22px;
    background: var(--bg-surface);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-pill);
    font-family: var(--font-family);
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: border-color var(--transition), background var(--transition), transform 0.18s ease;
  }

  .btn-browse:hover {
    border-color: var(--border-accent);
    background: var(--bg-elevated);
    transform: translateY(-1px);
  }

  /* Submit row â€” sits below the zone, separated cleanly */
  .upload-submit-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
  }

  .upload-submit-info {
    font-size: 0.8rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* Preview submit button â€” clearly outside and below zone */
  .btn-preview-submit {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 28px;
    background: var(--brand-gradient);
    color: #fff;
    border: none;
    border-radius: var(--radius-pill);
    font-family: var(--font-family);
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: var(--shadow-btn);
    transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
  }

  .btn-preview-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 36px rgba(247,37,133,0.45);
  }

  .btn-preview-submit:active   { transform: translateY(0); }

  .btn-preview-submit:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none;
  }

  /* Selected file indicator */
  .upload-file-selected {
    display: none;
    align-items: center;
    gap: 12px;
    padding: 12px 18px;
    background: rgba(34,197,94,0.08);
    border: 1px solid rgba(34,197,94,0.22);
    border-radius: var(--radius-md);
    margin-top: 20px;
  }

  .upload-file-selected.visible { display: flex; }

  .ufs-icon {
    width: 32px; height: 32px;
    border-radius: var(--radius-sm);
    background: rgba(34,197,94,0.12);
    display: grid;
    place-items: center;
    flex-shrink: 0;
    font-size: 1rem;
  }

  .ufs-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .ufs-size {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 500;
  }

  /* Format note below zone */
  .upload-zone-note {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    margin-top: 16px;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .upload-zone-note svg { width: 13px; height: 13px; flex-shrink: 0; }

  /* ============================================================
     3. DATASET PREVIEW SECTION
  ============================================================ */
  .preview-table-wrap {
    overflow-x: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    max-height: 320px;
    overflow-y: auto;
    /* Custom scrollbar */
    scrollbar-width: thin;
    scrollbar-color: var(--bg-elevated) transparent;
  }

  .preview-table-wrap::-webkit-scrollbar { width: 5px; height: 5px; }
  .preview-table-wrap::-webkit-scrollbar-track { background: transparent; }
  .preview-table-wrap::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 3px; }

  .preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
    min-width: 600px;
  }

  .preview-table thead {
    position: sticky;
    top: 0;
    z-index: 2;
  }

  .preview-table thead th {
    background: var(--bg-elevated);
    color: var(--text-muted);
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 11px 16px;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
    text-align: left;
  }

  .preview-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background var(--transition);
  }

  .preview-table tbody tr:last-child { border-bottom: none; }

  .preview-table tbody tr:hover { background: var(--bg-elevated); }

  .preview-table tbody td {
    padding: 10px 16px;
    color: var(--text-secondary);
    white-space: nowrap;
    font-family: 'Courier New', monospace;
    font-size: 0.78rem;
  }

  /* Row index column */
  .preview-table .row-idx {
    color: var(--text-muted);
    font-size: 0.7rem;
    width: 40px;
    text-align: center;
    font-family: var(--font-family);
    border-right: 1px solid var(--border);
  }

  /* Preview meta row above table */
  .preview-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 14px;
  }

  .preview-meta-title {
    font-size: 0.92rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--text-primary);
  }

  .preview-meta-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-pill);
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    letter-spacing: 0.04em;
  }

  /* ============================================================
     4. COLUMN VALIDATION SECTION
  ============================================================ */
  .validation-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 0;
  }

  .validation-block {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 20px 22px;
  }

  .val-block-title {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .val-block-title-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Column tag clouds */
  .col-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .col-tag {
    display: inline-block;
    padding: 4px 10px;
    border-radius: var(--radius-pill);
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    font-family: 'Courier New', monospace;
    transition: transform 0.15s ease;
  }

  .col-tag:hover { transform: translateY(-1px); }

  /* Model column â€” muted default */
  .col-tag-model {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    color: var(--text-secondary);
  }

  /* Missing â€” red */
  .col-tag-missing {
    background: rgba(247,37,133,0.10);
    border: 1px solid rgba(247,37,133,0.25);
    color: #f72585;
  }

  [data-theme="light"] .col-tag-missing { color: #c41062; }

  /* Extra â€” yellow/amber */
  .col-tag-extra {
    background: rgba(234,179,8,0.10);
    border: 1px solid rgba(234,179,8,0.28);
    color: #ca8a04;
  }

  [data-theme="dark"] .col-tag-extra { color: #facc15; }

  /* Validation status banners */
  .val-banner {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    padding: 16px 20px;
    border-radius: var(--radius-lg);
    border: 1px solid transparent;
    margin-top: 20px;
  }

  .val-banner-success {
    background: rgba(34,197,94,0.08);
    border-color: rgba(34,197,94,0.22);
    color: #16a34a;
  }

  [data-theme="dark"] .val-banner-success { color: #4ade80; }

  .val-banner-error {
    background: rgba(247,37,133,0.07);
    border-color: rgba(247,37,133,0.2);
    color: #f72585;
  }

  [data-theme="light"] .val-banner-error { color: #c41062; }

  .val-banner-icon {
    width: 32px; height: 32px;
    border-radius: var(--radius-sm);
    display: grid;
    place-items: center;
    font-size: 1rem;
    flex-shrink: 0;
  }

  .val-banner-success .val-banner-icon {
    background: rgba(34,197,94,0.12);
    border: 1px solid rgba(34,197,94,0.22);
  }

  .val-banner-error .val-banner-icon {
    background: rgba(247,37,133,0.12);
    border: 1px solid rgba(247,37,133,0.22);
  }

  .val-banner-body {}

  .val-banner-title {
    font-size: 0.88rem;
    font-weight: 700;
    letter-spacing: -0.01em;
    margin-bottom: 3px;
  }

  .val-banner-sub {
    font-size: 0.78rem;
    opacity: 0.8;
    line-height: 1.5;
  }

  /* ============================================================
     5. RUN PREDICTION CTA
  ============================================================ */
  .predict-cta {
    background: linear-gradient(135deg,
      rgba(247,37,133,0.07) 0%,
      rgba(155,45,202,0.07) 50%,
      rgba(67,97,238,0.07) 100%);
    border: 1px solid var(--border-accent);
    border-radius: var(--radius-xl);
    padding: 44px 40px;
    text-align: center;
    position: relative;
    overflow: hidden;
    margin-top: 0;
    box-shadow: var(--shadow-glow);
  }

  .predict-cta::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--brand-gradient);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  }

  .predict-cta-title {
    font-size: clamp(1.2rem, 2.5vw, 1.65rem);
    font-weight: 800;
    letter-spacing: -0.04em;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .predict-cta-sub {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 28px;
    max-width: 440px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.65;
  }

  /* Big gradient prediction button */
  .btn-predict {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 16px 40px;
    background: var(--brand-gradient);
    color: #fff;
    border: none;
    border-radius: var(--radius-pill);
    font-family: var(--font-family);
    font-size: 1.05rem;
    font-weight: 800;
    cursor: pointer;
    letter-spacing: 0.01em;
    box-shadow: 0 8px 32px rgba(247,37,133,0.4);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .btn-predict::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,0);
    transition: background 0.18s ease;
  }

  .btn-predict:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 14px 48px rgba(247,37,133,0.5);
  }

  .btn-predict:hover::before { background: rgba(255,255,255,0.07); }
  .btn-predict:active         { transform: translateY(0) scale(1); }

  .btn-predict.loading {
    pointer-events: none;
    opacity: 0.8;
  }

  .btn-predict-icon {
    width: 26px; height: 26px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: grid;
    place-items: center;
    flex-shrink: 0;
  }

  /* Filename chip above button */
  .predict-file-chip {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 5px 14px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-pill);
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 20px;
    font-family: 'Courier New', monospace;
  }

  .predict-file-chip-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: #22c55e;
    flex-shrink: 0;
  }

  /* ============================================================
     RESPONSIVE
  ============================================================ */
  @media (max-width: 768px) {
    .upload-header      { flex-direction: column; }
    .validation-grid    { grid-template-columns: 1fr; }
    .predict-cta        { padding: 36px 24px; }
    .upload-zone        { padding: 40px 20px; }
    .up-section-card    { padding: 24px 20px; }
    .btn-predict        { font-size: 0.95rem; padding: 14px 28px; }
  }
</style>
{% endblock %}


{% block content %}

<!-- ============================================================
     1. PAGE HEADER
============================================================ -->
<div class="upload-header fade-up">
  <div class="upload-header-text">
    <div class="up-label">Data Ingestion</div>
    <h1 class="upload-h1">Upload Your <span>Dataset</span></h1>
    <p class="upload-sub">
      Upload a <code style="font-size:0.82em;background:var(--bg-elevated);padding:2px 6px;border-radius:4px;border:1px solid var(--border);color:var(--text-secondary)">.csv</code> file containing your customer records.
      Custora AI will score every customer for churn probability and generate
      AI-powered retention strategies.
    </p>
    <a href="https://drive.google.com/file/d/1-R2ho-Tqym6HG0pirJqzqJpIFYiwWzo3/view?usp=sharing">Test With This Dataset</a>
    <!-- Required column hints -->
    <div class="upload-format-row">
      <span class="format-label">Expected columns:</span>
      {% if model_columns %}
        {% for col in model_columns %}
          <span class="format-pill">{{ col }}</span>
        {% endfor %}
      {% else %}
        <span class="format-pill">CustomerID</span>
        <span class="format-pill">tenure</span>
        <span class="format-pill">MonthlyCharges</span>
        <span class="format-pill">TotalCharges</span>
        <span class="format-pill">Contract</span>
        <span class="format-pill">+ more</span>
      {% endif %}
    </div>
  </div>
</div>


<!-- ============================================================
     2. DRAG & DROP UPLOAD ZONE
============================================================ -->
<div class="up-section">
  <div class="up-section-card fade-up">

    <!-- Form â€” method, enctype, field names preserved -->
    <form method="POST" enctype="multipart/form-data" id="uploadForm">
      <input type="hidden" name="action" value="preview">

      <!-- File input: hidden, outside zone, triggered only via browseBtn click or drag-drop -->
      <input type="file" name="file" id="fileInput" accept=".csv" required />

      <!-- Drop zone: purely visual â€” no inputs inside -->
      <div class="upload-zone" id="uploadZone">

        <div class="upload-zone-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 16V4m0 0L8 8m4-4l4 4" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke-linecap="round"/>
          </svg>
        </div>

        <div class="upload-zone-title" id="zoneTitle">Drop your CSV file here</div>
        <p class="upload-zone-sub" id="zoneSub">or click <strong>Choose File</strong> below to browse</p>

        <!-- type="button" â€” only opens file picker, never submits -->
        <button type="button" class="btn-browse" id="browseBtn">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <path d="M2 10V5a1 1 0 011-1h3l1.5-1.5H11a1 1 0 011 1v6.5a1 1 0 01-1 1H3a1 1 0 01-1-1z" stroke="currentColor" stroke-width="1.3" fill="none"/>
          </svg>
          Choose File
        </button>

      </div>

      <!-- File selected indicator (hidden until file chosen) -->
      <div class="upload-file-selected" id="fileSelected">
        <div class="ufs-icon">ðŸ“„</div>
        <span class="ufs-name" id="ufsName">â€”</span>
        <span class="ufs-size" id="ufsSize"></span>
      </div>

      <!-- Submit row â€” clearly separated from the browse zone -->
      <div class="upload-submit-row">
        <span class="upload-submit-info" id="submitInfo">
          <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="currentColor" stroke-width="1.3">
            <circle cx="6.5" cy="6.5" r="5.5"/>
            <path d="M6.5 6v3M6.5 4.5v.01" stroke-linecap="round"/>
          </svg>
          Select a CSV file first
        </span>
        <button type="submit" class="btn-preview-submit" id="previewBtn" disabled>
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <path d="M7 1v8M4 4L7 1l3 3M1 11h12" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Preview Dataset
        </button>
      </div>

    </form>

    <!-- Format note -->
    <div class="upload-zone-note">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3">
        <circle cx="8" cy="8" r="6.5"/>
        <path d="M8 7v4M8 5.5v.01" stroke-linecap="round"/>
      </svg>
      Accepted format: <strong>.csv</strong> with headers in the first row. Max recommended size: 50 MB.
    </div>

  </div>
</div>


<!-- ============================================================
     IF FILE UPLOADED â€” PREVIEW + VALIDATION + CTA
============================================================ -->
{% if file_uploaded %}

  <!-- â”€â”€ Dataset Preview â”€â”€ -->
  <div class="up-section">
    <div class="up-section-card fade-up">

      <div class="preview-meta">
        <div>
          <div class="up-label">Dataset Preview</div>
          <div class="preview-meta-title">First 5 rows of uploaded data</div>
        </div>
        <div class="preview-meta-badge">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
            <circle cx="5" cy="5" r="4" fill="#22c55e"/>
          </svg>
          {{ columns | length }} columns detected
        </div>
      </div>

      <!-- Scrollable table â€” columns + preview Jinja vars preserved -->
      <div class="preview-table-wrap">
        <table class="preview-table">
          <thead>
            <tr>
              <th class="row-idx">#</th>
              {% for col in columns %}
              <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in preview %}
            <tr>
              <td class="row-idx">{{ loop.index }}</td>
              {% for col in columns %}
              <td>{{ row[col] }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>


  <!-- â”€â”€ Column Validation â”€â”€ -->
  <div class="up-section">
    <div class="up-section-card fade-up">

      <div class="up-label">Column Validation</div>
      <div class="preview-meta" style="margin-bottom:20px;">
        <div class="preview-meta-title">Schema check against trained model</div>
      </div>

      <div class="validation-grid">

        <!-- Model trained columns â€” model_columns Jinja var preserved -->
        <div class="validation-block">
          <div class="val-block-title">
            <div class="val-block-title-dot" style="background:var(--brand-purple)"></div>
            Model expects
          </div>
          <div class="col-tags">
            {% for col in model_columns %}
            <span class="col-tag col-tag-model">{{ col }}</span>
            {% endfor %}
          </div>
        </div>

        <!-- Missing + Extra columns â€” Jinja vars preserved -->
        <div class="validation-block">

          <!-- Missing columns â€” missing_cols Jinja var preserved -->
          {% if missing_cols %}
          <div style="margin-bottom:16px;">
            <div class="val-block-title">
              <div class="val-block-title-dot" style="background:#f72585"></div>
              Missing columns
            </div>
            <div class="col-tags">
              {% for col in missing_cols %}
              <span class="col-tag col-tag-missing">âœ• {{ col }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Extra columns â€” extra_cols Jinja var preserved -->
          {% if extra_cols %}
          <div>
            <div class="val-block-title">
              <div class="val-block-title-dot" style="background:#ca8a04"></div>
              Extra columns
            </div>
            <div class="col-tags">
              {% for col in extra_cols %}
              <span class="col-tag col-tag-extra">+ {{ col }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if not missing_cols and not extra_cols %}
          <div class="val-block-title">
            <div class="val-block-title-dot" style="background:#22c55e"></div>
            Schema status
          </div>
          <div class="col-tags">
            <span class="col-tag" style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.22);color:#22c55e">
              âœ“ All columns matched
            </span>
          </div>
          {% endif %}

          {% if not missing_cols and extra_cols %}
          <div class="col-tags" style="margin-top:12px;">
            <span class="col-tag" style="background:rgba(234,179,8,0.1);border:1px solid rgba(234,179,8,0.22);color:#ca8a04">
              âš  Extra columns will be ignored
            </span>
          </div>
          {% endif %}

        </div>

      </div>

      <!-- Status banner -->
      {% if missing_cols %}
      <div class="val-banner val-banner-error">
        <div class="val-banner-icon">âœ•</div>
        <div class="val-banner-body">
          <div class="val-banner-title">Dataset is incompatible with the model</div>
          <div class="val-banner-sub">
            {{ missing_cols | length }} required column{{ 's' if missing_cols | length > 1 else '' }} missing.
            Please re-upload a CSV that includes all expected columns.
          </div>
        </div>
      </div>
      {% else %}
      <div class="val-banner val-banner-success">
        <div class="val-banner-icon">âœ“</div>
        <div class="val-banner-body">
          <div class="val-banner-title">Dataset is compatible with the model</div>
          <div class="val-banner-sub">
            All required columns detected. Ready to run churn prediction.
            {% if extra_cols %}{{ extra_cols | length }} extra column{{ 's' if extra_cols | length > 1 else '' }} will be ignored.{% endif %}
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>


  <!-- â”€â”€ Run Prediction CTA â€” only if no missing cols â”€â”€ -->
  <!-- missing_cols Jinja condition + filename var + form fields preserved -->
  {% if not missing_cols %}

  <div class="up-section" style="padding-bottom: 80px;">
    <div class="predict-cta fade-up">

      <!-- Filename chip â€” filename Jinja var preserved -->
      <div class="predict-file-chip">
        <div class="predict-file-chip-dot"></div>
        {{ filename }}
      </div>

      <h2 class="predict-cta-title">Ready to run prediction</h2>
      <p class="predict-cta-sub">
        Your dataset passed all validation checks. Click below to run the
        full ML ensemble pipeline and generate your churn report.
      </p>

      <!-- Predict form â€” action + filename hidden fields preserved -->
      <form method="POST" id="predictForm">
        <input type="hidden" name="action" value="predict">
        <input type="hidden" name="filename" value="{{ filename }}">

        <button type="submit" class="btn-predict" id="predictBtn">
          <span class="btn-predict-icon">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
              <path d="M3 7h8M8 4l3 3-3 3" stroke="white" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          Run Prediction
        </button>
      </form>

    </div>
  </div>

  {% endif %}

{% endif %}

{% endblock %}


{% block extra_js %}
<script>
  const uploadZone  = document.getElementById('uploadZone');
  const fileInput   = document.getElementById('fileInput');
  const browseBtn   = document.getElementById('browseBtn');
  const previewBtn  = document.getElementById('previewBtn');
  const fileSelected = document.getElementById('fileSelected');
  const ufsName     = document.getElementById('ufsName');
  const ufsSize     = document.getElementById('ufsSize');
  const zoneTitle   = document.getElementById('zoneTitle');
  const zoneSub     = document.getElementById('zoneSub');
  const submitInfo  = document.getElementById('submitInfo');

  /* â”€â”€ File size formatter â”€â”€ */
  function formatBytes(bytes) {
    if (bytes < 1024)    return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  /* â”€â”€ Update UI after file is chosen â”€â”€ */
  function onFileSelected(file) {
    ufsName.textContent  = file.name;
    ufsSize.textContent  = formatBytes(file.size);
    fileSelected.classList.add('visible');

    zoneTitle.textContent = file.name;
    zoneTitle.style.color = '';
    zoneSub.textContent   = formatBytes(file.size) + ' Â· CSV ready to preview';
    uploadZone.classList.add('has-file');
    uploadZone.style.borderColor = '#22c55e';
    uploadZone.style.boxShadow   = '0 0 0 4px rgba(34,197,94,0.1)';

    /* Enable submit button */
    previewBtn.disabled = false;
    submitInfo.innerHTML = `
      <svg width="13" height="13" viewBox="0 0 13 13" fill="none" stroke="#22c55e" stroke-width="1.3">
        <circle cx="6.5" cy="6.5" r="5.5"/>
        <path d="M4 6.5l2 2 3-3" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span style="color:#22c55e;font-weight:600">${file.name}</span>
    `;
  }

  /* â”€â”€ Browse button: opens file picker only â”€â”€ */
  browseBtn.addEventListener('click', () => fileInput.click());

  /* â”€â”€ File input change handler â”€â”€ */
  fileInput.addEventListener('change', () => {
    if (fileInput.files[0]) onFileSelected(fileInput.files[0]);
  });

  /* â”€â”€ Drag & drop on zone â”€â”€ */
  ['dragenter', 'dragover'].forEach(ev => {
    uploadZone.addEventListener(ev, e => {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });
  });

  ['dragleave', 'drop'].forEach(ev => {
    uploadZone.addEventListener(ev, e => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
    });
  });

  uploadZone.addEventListener('drop', e => {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      if (files[0].name.endsWith('.csv')) {
        const dt = new DataTransfer();
        dt.items.add(files[0]);
        fileInput.files = dt.files;
        onFileSelected(files[0]);
      } else {
        /* Invalid type feedback */
        uploadZone.style.borderColor = 'var(--brand-pink)';
        uploadZone.style.boxShadow   = '0 0 0 4px rgba(247,37,133,0.12)';
        zoneTitle.textContent = 'Only .csv files are accepted';
        zoneTitle.style.color = '#f72585';
        zoneSub.textContent   = 'Please drop a valid CSV file';
        setTimeout(() => {
          uploadZone.style.borderColor = '';
          uploadZone.style.boxShadow   = '';
          zoneTitle.textContent = 'Drop your CSV file here';
          zoneTitle.style.color = '';
          zoneSub.textContent   = 'or click Choose File below to browse';
        }, 2200);
      }
    }
  });

  /* â”€â”€ Preview submit: loading state â”€â”€ */
  const uploadForm = document.getElementById('uploadForm');
  if (uploadForm && previewBtn) {
    uploadForm.addEventListener('submit', () => {
      previewBtn.disabled = true;
      previewBtn.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 18 18" fill="none" style="animation:spin 0.75s linear infinite;flex-shrink:0">
          <circle cx="9" cy="9" r="7" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
          <path d="M9 2a7 7 0 017 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Loading previewâ€¦
      `;
    });
  }

  /* â”€â”€ Predict button loading state â”€â”€ */
  const predictForm = document.getElementById('predictForm');
  const predictBtn  = document.getElementById('predictBtn');

  if (predictForm && predictBtn) {
    predictForm.addEventListener('submit', () => {
      predictBtn.classList.add('loading');
      predictBtn.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" style="animation:spin 0.8s linear infinite;flex-shrink:0">
          <circle cx="9" cy="9" r="7" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
          <path d="M9 2a7 7 0 017 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Running ML pipelineâ€¦
      `;
    });
  }

  /* â”€â”€ Spin keyframe â”€â”€ */
  const styleEl = document.createElement('style');
  styleEl.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
  document.head.appendChild(styleEl);
</script>
{% endblock %}